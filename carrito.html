<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="El carrito de compras de Puros Mates.">
    <link rel="icon" href="./img/favicon.ico" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <title>Carrito - Puros Mates</title>
    
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-16987721324"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-16987721324');
</script>
<body>
    <header class="main-header">
        <nav class="navbar">
            <div class="header-logo">
                <a href="./index.html">
                    <img src="./img/favicon.ico" alt="Puros Mates Logo" class="header-logo-img">
                </a>
                <a href="./index.html">PUROS MATES</a>
            </div>
            <div class="nav-links-group">
                <ul class="header-list">
                    <li><a href="./catalogo.html">Productos</a></li>
                    <li><a href="./carrito.html">Carrito</a></li>
                </ul>
                <a href="./catalogo.html" class="btn-comprar">Comprar Ahora</a>
                <div class="main-nav-mobile">
                    <button class="main-header-burguer">
                        <div></div>
                        <div></div>
                        <div></div>
                    </button>
                </div>
            </div>
            
        </nav>
    </header>

    <div class="mobile-menu">
        <ul>
            <li><a href="./catalogo.html">Catálogo</a></li>
            <li><a href="./index.html">Sobre Nosotros</a></li>
            <li><a href="./contacto.html">Contacto</a></li>
            <li><a href="./carrito.html">Carrito</a></li>
        </ul>
    </div>

    <div class="carrito-container">
        <h1 class="carrito-title">Tu Carrito</h1>
        
        <div class="carrito-items" id="carrito-items">
            <!-- Los items se cargarán dinámicamente -->
        </div>

        <div class="carrito-total">
            <div id="grabado-mensaje"></div>
            <div id="grabado-opciones" style="display: none;">
                <!-- Las opciones de grabado se cargarán dinámicamente -->
            </div>
            <h3>Precio estimado: $<span id="total-precio">0</span></h3>
        </div>

        <button class="btn-whatsapp" onclick="enviarPedidoWhatsApp()">
            Realizar Pedido por WhatsApp
        </button>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <div class="footer-logo">
                    <a href="./index.html">PUROS MATES</a>
                    <a href="./index.html">
                        <img src="./img/favicon.ico" alt="Puros Mates Logo" class="footer-favicon">
                    </a>
                </div>
            </div>
            <div class="footer-column">
                <a href="./catalogo.html">
                    <h3>Productos</h3>
                </a>
                <ul>
                    <li><a href="./catalogo.html#mate">Mates</a></li>
                    <li><a href="./catalogo.html#bombilla">Bombillas</a></li>
                    <li><a href="./catalogo.html#accesorio">Accesorios</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <a href="./index.html">
                    <h3>Puros Mates</h3>
                </a>
                <ul>
                    <li><a href="./contacto.html">Contacto</a></li>
                    <li><a href="./index.html">Sobre Nosotros</a></li>
                    <li class="contacto-redes">
                        <a href="https://www.instagram.com/puros.mates/" target="_blank" aria-label="Síguenos en Instagram">
                            <img src="./img/logo-instagram.webp" alt="Instagram de PM" class="contacto-icon icon-instagram">
                        </a>
                        <a href="https://wa.me/5491130548207" target="_blank" aria-label="Contáctanos por WhatsApp">
                            <img src="./img/logo-wpp.webp" alt="WhatsApp de PM" class="contacto-icon icon-wpp">
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-text">Copyright © Puros Mates 2024</div>
        </div>
    </footer>

    <script>
        let productosData = [];
        let descuento = 0; // Variable global para el descuento

        // Cargar productos.json al iniciar
        fetch('./productos.json')
            .then(res => res.json())
            .then(data => { productosData = data.productos; });

        function cargarCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const contenedor = document.getElementById('carrito-items');
            const grabadoOpciones = document.getElementById('grabado-opciones');
            const grabadoMensaje = document.getElementById('grabado-mensaje');
            
            contenedor.innerHTML = '';
            grabadoOpciones.innerHTML = '';
            
            if (carrito.length === 0) {
                contenedor.innerHTML = `
                    <p>Tu carrito está vacío</p>
                    <a href="./catalogo.html" class="btn-comprar">Comprar Ahora</a>
                `;
                grabadoOpciones.style.display = 'none';
                grabadoMensaje.innerHTML = '';
                document.getElementById('total-precio').textContent = '0';
                descuento = 0; 
                return;
            }

            let hayProductosAptos = false;
            let total = 0;
            let hayMate = false;
            let hayBombilla = false;

            carrito.forEach((item, index) => {
                if (item.aptoParaGrabado === true) {
                    hayProductosAptos = true;
                }
                if (item.tipos.includes('mate')) hayMate = true;
                if (item.tipos.includes('bombilla')) hayBombilla = true;
                total += item.precio;
                const itemElement = document.createElement('div');
                itemElement.className = 'carrito-item';
                itemElement.innerHTML = `
                    <img src="${item.imagen}" alt="${item.nombre}" loading="lazy" onclick="ampliarImagenCarrito('${item.imagen}', '${item.nombre}')">
                    <div class="item-details">
                        <h3>${item.nombre}</h3>
                        <p>$${item.precio}</p>
                    </div>
                    <button class="btn-eliminar-cart" onclick="eliminarDelCarrito(${index})">Eliminar</button>
                `;
                contenedor.appendChild(itemElement);
            });

            // Aplicar descuento si hay mate y bombilla
            descuento = 0; 
            if (hayMate && hayBombilla) {
                descuento = Math.round(total * 0.1);
                const descuentoElement = document.createElement('div');
                descuentoElement.className = 'carrito-item descuento-item';
                descuentoElement.innerHTML = `
                    <div class="item-details">
                        <h3>Descuento mate + bombilla (10% OFF)</h3>
                    </div>
                    <div class="descuento-valor">-$${descuento}</div>
                `;
                contenedor.appendChild(descuentoElement);
            }

            // Mostrar el total con descuento aplicado
            document.getElementById('total-precio').textContent = total - descuento;

            if (hayProductosAptos) {
                grabadoOpciones.style.display = 'block';
                grabadoMensaje.innerHTML = '';
                
                // Crear opciones de grabado solo para productos aptos
                carrito.forEach((item, index) => {
                    if (item.aptoParaGrabado === true) {
                        const grabadoOpcion = document.createElement('div');
                        grabadoOpcion.className = 'grabado-opcion';
                        grabadoOpcion.innerHTML = `
                            <label>
                                <input type="checkbox" id="grabado-${index}" onchange="actualizarTotal()">
                                Agregar grabado láser en ${item.nombre} (+$20.000)
                            </label>
                        `;
                        grabadoOpciones.appendChild(grabadoOpcion);
                    }
                });
            } else {
                grabadoOpciones.style.display = 'none';
                grabadoMensaje.innerHTML = '<p class="mensaje-no-grabado">Los productos seleccionados no son aptos para grabado láser</p>';
            }
            actualizarTotal();
        }

        function actualizarTotal() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const totalElement = document.getElementById('total-precio');
            
            let total = carrito.reduce((sum, item) => sum + item.precio, 0);
            
            // Sumar el costo de cada grabado seleccionado solo para productos aptos
            carrito.forEach((item, index) => {
                if (item.aptoParaGrabado === true) {
                    const checkbox = document.getElementById(`grabado-${index}`);
                    if (checkbox && checkbox.checked) {
                        total += 20000;
                    }
                }
            });
            
            totalElement.textContent = total - descuento;
        }

        function eliminarDelCarrito(index) {
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            carrito.splice(index, 1);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            cargarCarrito();
        }

        function enviarPedidoWhatsApp() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            
            let mensaje = "¡Hola! Quiero realizar el siguiente pedido:\n\n";
            
            carrito.forEach((item, index) => {
                mensaje += `- ${item.nombre}: $${item.precio}\n`;
                if (item.aptoParaGrabado === true) {
                    const checkbox = document.getElementById(`grabado-${index}`);
                    if (checkbox && checkbox.checked) {
                        mensaje += `  * Con grabado láser (+$20.000)\n`;
                    }
                }
            });
            
            mensaje += `\nTotal (estimado): $${document.getElementById('total-precio').textContent}`;
            const numero = "+5491130548207";
            const whatsappUrl = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
        }

        document.addEventListener('DOMContentLoaded', cargarCarrito);

        // Control del menú móvil
        const burgerButton = document.querySelector('.main-header-burguer');
        const mobileMenu = document.querySelector('.mobile-menu');

        burgerButton.addEventListener('click', () => {
            burgerButton.classList.toggle('active');
            mobileMenu.classList.toggle('active');
        });

        // Cerrar menú al hacer clic en un enlace
        const mobileLinks = document.querySelectorAll('.mobile-menu a');
        mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
                burgerButton.classList.remove('active');
                mobileMenu.classList.remove('active');
            });
        });

        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!burgerButton.contains(e.target) && !mobileMenu.contains(e.target)) {
                burgerButton.classList.remove('active');
                mobileMenu.classList.remove('active');
            }
        });

        // Modal para ampliar imagen del carrito con slider
        function ampliarImagenCarrito(src, alt) {
            // Buscar el producto en productosData
            let producto = productosData.find(p => p.imagen === src || p.nombre === alt);
            if (!producto) {
                // fallback: solo mostrar la imagen clickeada
                producto = { imagen: src, fotosExtras: [] };
            }
            const imagenes = [producto.imagen, ...(producto.fotosExtras || [])].filter(Boolean);
            let actual = imagenes.indexOf(src);
            if (actual === -1) actual = 0;

            // Crear overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-imagen-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) cerrarModalImagenCarrito(); };

            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal-imagen';

            // Botón cerrar
            const btnCerrar = document.createElement('button');
            btnCerrar.className = 'modal-imagen-cerrar';
            btnCerrar.innerHTML = '&times;';
            btnCerrar.onclick = cerrarModalImagenCarrito;

            // Flechas SVG lindas
            function flechaSVG(direccion) {
                if (direccion === 'izq') {
                    return `<svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`;
                } else {
                    return `<svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>`;
                }
            }
            const btnPrev = document.createElement('button');
            btnPrev.className = 'modal-imagen-flecha izq';
            btnPrev.innerHTML = flechaSVG('izq');
            btnPrev.onclick = (e) => { e.stopPropagation(); cambiar(-1); };

            const btnNext = document.createElement('button');
            btnNext.className = 'modal-imagen-flecha der';
            btnNext.innerHTML = flechaSVG('der');
            btnNext.onclick = (e) => { e.stopPropagation(); cambiar(1); };

            // Imagen
            const img = document.createElement('img');
            function renderImg() {
                img.src = imagenes[actual];
                img.alt = alt;
            }
            renderImg();

            // Slider logic
            function cambiar(dir) {
                actual = (actual + dir + imagenes.length) % imagenes.length;
                renderImg();
            }

            // Navegación con teclado
            function keyHandler(e) {
                if (e.key === 'ArrowLeft') cambiar(-1);
                if (e.key === 'ArrowRight') cambiar(1);
                if (e.key === 'Escape') cerrarModalImagenCarrito();
            }
            setTimeout(() => document.addEventListener('keydown', keyHandler), 10);

            // Armar modal
            modal.appendChild(btnCerrar);
            if (imagenes.length > 1) modal.appendChild(btnPrev);
            modal.appendChild(img);
            if (imagenes.length > 1) modal.appendChild(btnNext);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Guardar referencia para cerrar y limpiar event
            window._cerrarModalImagenCarrito = () => {
                document.removeEventListener('keydown', keyHandler);
                cerrarModalImagenCarrito();
            };
        }
        function cerrarModalImagenCarrito() {
            const overlay = document.querySelector('.modal-imagen-overlay');
            if (overlay) overlay.remove();
            if (window._cerrarModalImagenCarrito) {
                document.removeEventListener('keydown', window._cerrarModalImagenCarrito);
                window._cerrarModalImagenCarrito = null;
            }
        }
    </script>
</body>
</html>