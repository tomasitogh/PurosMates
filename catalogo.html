<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="El catálogo de productos de Puros Mates.">
    <link rel="icon" href="./img/favicon.ico" type="image/png">
    <link rel="stylesheet" href="style.css">
    <title>Catálogo - Puros Mates</title>
</head>
<body>
    <header class="main-header">
        <nav class="navbar">
            <div class="header-logo">
                <a href="./index.html">
                    <img src="./img/favicon.ico" alt="Puros Mates Logo" class="header-logo-img">
                </a>
                <a href="./index.html">PUROS MATES</a>
            </div>
            <div class="nav-links-group">
                <ul class="header-list">
                    <li><a href="./catalogo.html">Productos</a></li>
                    <li><a href="./carrito.html">Carrito</a></li>
                </ul>
                <a href="./catalogo.html" class="btn-comprar">Comprar Ahora</a>
                <div class="main-nav-mobile">
                    <button class="main-header-burguer">
                        <div></div>
                        <div></div>
                        <div></div>
                    </button>
                </div>
            </div>
            
        </nav>
    </header>

    <div class="mobile-menu">
        <ul>
            <li><a href="./catalogo.html">Catálogo</a></li>
            <li><a href="./index.html">Sobre Nosotros</a></li>
            <li><a href="./contacto.html">Contacto</a></li>
            <li><a href="./carrito.html">Carrito</a></li>
        </ul>
    </div>

    <div class="catalogo-container">
        <h1 class="catalogo-title">Productos</h1>
        <div class="filtros-container-title">
                <h3>Filtrar por:</h3>
        </div>
        <div class="filtros-container">
            <div class="filtro-item" data-filtro="mate" onclick="toggleFiltro(this)">
                <h3>Mates</h3>
            </div>
            <div class="filtro-item" data-filtro="bombilla" onclick="toggleFiltro(this)">
                <h3>Bombillas</h3>
            </div>
            <div class="filtro-item" data-filtro="accesorio" onclick="toggleFiltro(this)">
                <h3>Accesorios</h3>
            </div>
        </div>

        <div class="productos-grid" id="productos-grid">
            <!-- Los productos se cargarán dinámicamente con JavaScript -->
        </div>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <div class="footer-logo">
                    <a href="./index.html">PUROS MATES</a>
                    <a href="./index.html">
                        <img src="./img/favicon.ico" alt="Puros Mates Logo" class="footer-favicon">
                    </a>
                </div>
            </div>
            <div class="footer-column">
                <a href="./catalogo.html">
                    <h3>Productos</h3>
                </a>
                <ul>
                    <li><a href="./catalogo.html#mate">Mates</a></li>
                    <li><a href="./catalogo.html#bombilla">Bombillas</a></li>
                    <li><a href="./catalogo.html#accesorio">Accesorios</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <a href="./index.html">
                    <h3>Puros Mates</h3>
                </a>
                <ul>
                    <li><a href="./contacto.html">Contacto</a></li>
                    <li><a href="./index.html">Sobre Nosotros</a></li>
                    <li class="contacto-redes">
                        <a href="https://www.instagram.com/puros.mates/" target="_blank" aria-label="Síguenos en Instagram">
                            <img src="./img/logo-instagram.webp" alt="Instagram" class="contacto-icon icon-instagram">
                        </a>
                        <a href="https://wa.me/5491125129852" target="_blank" aria-label="Contáctanos por WhatsApp">
                            <img src="./img/logo-wpp.webp" alt="WhatsApp" class="contacto-icon icon-wpp">
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-text">Copyright © Puros Mates 2024</div>
        </div>
    </footer>

    <a href="./carrito.html" class="carrito-flotante" id="carrito-flotante">
        <div class="carrito-contador" id="carrito-contador">0</div>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
    </a>

    <style>
        .carrito-contador {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff0000;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .carrito-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
        }

        .carrito-flotante.visible {
            opacity: 1;
            visibility: visible;
        }

        .carrito-flotante svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .carrito-flotante:hover {
            transform: scale(1.1);
        }

        /* Estilos para el panel lateral del carrito */
        .carrito-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: right 0.3s ease-in-out;
            padding: 20px;
            overflow-y: auto;
        }

        .carrito-panel.active {
            right: 0;
        }

        .carrito-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .carrito-panel-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .carrito-panel-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .carrito-panel-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
        }

        .carrito-panel-item-info {
            flex-grow: 1;
        }

        .btn-eliminar {
            background-color: #ff4444;
            border: none;
            border-radius: 50%;
            min-width: 30px;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            padding: 0;
            margin-left: 10px;
        }

        .btn-eliminar:hover {
            background-color: #ff0000;
        }

        .btn-eliminar svg {
            fill: white;
            width: 20px;
            height: 20px;
        }

        .carrito-panel-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            font-weight: bold;
        }

        .carrito-panel-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .carrito-panel-buttons button {
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-ir-carrito {
            background-color: #333;
            color: white;
        }

        .btn-seguir-comprando {
            background-color: #f0f0f0;
            color: #333;
        }

        /* Overlay para el panel lateral */
        .carrito-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }

        .carrito-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Estilos para el modal móvil */
        .carrito-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 400px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .carrito-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .carrito-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .carrito-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            position: relative;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #modal-timer-circle {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            width: 32px;
            height: 32px;
            pointer-events: none;
        }
        #modal-timer-progress {
            transition: stroke-dashoffset 0.1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .carrito-modal-content {
            text-align: center;
        }

        .carrito-modal-content img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            margin: 0 auto 15px;
            display: block;
        }

        .carrito-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .carrito-modal-buttons button {
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .descuento-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .descuento-item h3 {
            color: #2d5d52;
            margin: 0;
        }

        .descuento-valor {
            color: #2d5d52;
            font-weight: bold;
            font-size: 1.1em;
        }

        .carrito-modal-close span {
            position: relative;
            z-index: 2;
            color: #38675a;
        }

        @media (max-width: 768px) {
            .carrito-panel {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .carrito-modal {
                display: none;
            }
        }

        .modal-item-unificado, .carrito-modal-item, .descuento-item, .total-modal-item {
            max-width: 500px;
            width: 100%;
            margin: 0 auto 10px auto !important;
            box-sizing: border-box;
            border-radius: 8px;
            background: #fff;
        }
        .total-modal-item {
            display: flex !important;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #eee;
            margin-top: 10px !important;
            padding-top: 10px;
            font-weight: bold;
            color: #2d5d52;
            font-size: 1.1em;
        }
        .total-modal-label {
            font-weight: bold;
            color: #2d5d52;
        }
        .total-modal-value {
            font-weight: bold;
            color: #2d5d52;
        }
        @media (max-width: 600px) {
            .modal-item-unificado, .carrito-modal-item, .descuento-item, .total-modal-item {
                width: 100%;
                border-radius: 0;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }

        .colores-disponibles {
            margin: 0 0 4px 0;
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 0 16px;
        }
        .color-circulo {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
            position: relative;
        }
    </style>

    <script>
        let productos = [];
        let coloresGlobales = {};

        // Función para cargar los productos desde el archivo JSON
        async function cargarProductos() {
            try {
                const response = await fetch('./productos.json');
                const data = await response.json();
                coloresGlobales = data.colores || {};
                productos = data.productos;
                filtrarProductos(); // Filtrar productos después de cargarlos
            } catch (error) {
                console.error('Error al cargar los productos:', error);
            }
        }

        function obtenerFiltrosActivos() {
            const filtrosActivos = document.querySelectorAll('.filtro-item.activo');
            return Array.from(filtrosActivos).map(filtro => filtro.dataset.filtro);
        }

        function toggleFiltro(elemento) {
            elemento.classList.toggle('activo');
            filtrarProductos();
        }

        function filtrarProductos() {
            const filtrosActivos = obtenerFiltrosActivos();
            const grid = document.getElementById('productos-grid');
            grid.innerHTML = '';

            const productosFiltrados = productos.filter(producto => {
                if (filtrosActivos.length === 0) return true;
                return filtrosActivos.some(filtro => producto.tipos.includes(filtro));
            });

            productosFiltrados.forEach(producto => {
                const productoElement = document.createElement('div');
                productoElement.className = 'producto-card';
                productoElement.innerHTML = `
                    <div class="stock-badge ${!producto.stock ? 'sin-stock' : ''}">
                        ${!producto.stock ? 'Sin stock' : 'En stock'}
                    </div>
                    ${!producto.stock ? '<div class="encargue-badge">Se pide por encargue</div>' : ''}
                    <img src="${producto.imagen}" alt="${producto.nombre}" loading="lazy">
                    <h3>${producto.nombre}</h3>
                    <p>${producto.descripcion}</p>
                    ${(producto.colores && producto.colores.length > 0) ? `
                        <h4 style="margin: 0 0 2px 0; font-size: 1em; font-weight: bold; color: rgba(45, 93, 82); padding: 0 16px;">Colores disponibles</h4>
                    ` : ''}
                    <div class="colores-disponibles">
                        ${(producto.colores || []).map(colorKey => {
                            const colorHex = coloresGlobales[colorKey];
                            return `<span class="color-circulo" style="background:${colorHex}"></span>`;
                        }).join('')}
                    </div>
                    <p class="precio">$${producto.precio}</p>
                    <button onclick="${!producto.stock ? `abrirEncargueWhatsapp(${producto.id})` : `event.stopPropagation(); agregarAlCarrito(${producto.id})`}" 
                            class="btn-agregar ${!producto.stock ? 'pedir-encargue' : ''}">
                        ${!producto.stock ? 'Pedir por encargue' : 'Agregar al carrito'}
                    </button>
                `;
                
                // Agregar evento click para mostrar el panel
                productoElement.addEventListener('click', () => mostrarPanelProducto(producto.id));
                
                grid.appendChild(productoElement);
            });
        }

        function activarFiltroPorHash() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                // Desactivar todos los filtros primero
                document.querySelectorAll('.filtro-item').forEach(filtro => {
                    filtro.classList.remove('activo');
                });
                
                // Activar el filtro correspondiente al hash
                const filtroElement = document.querySelector(`.filtro-item[data-filtro="${hash}"]`);
                if (filtroElement) {
                    filtroElement.classList.add('activo');
                }
            }
        }

        function actualizarContadorCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const contador = document.getElementById('carrito-contador');
            contador.textContent = carrito.length;
        }

        function calcularTotalCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            return carrito.reduce((total, item) => total + item.precio, 0);
        }

        function actualizarPanelCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const panelItems = document.getElementById('carrito-panel-items');
            const totalElement = document.getElementById('carrito-panel-total');
            
            panelItems.innerHTML = '';
            let total = 0;
            let hayMate = false;
            let hayBombilla = false;

            carrito.forEach((item, index) => {
                // Verificar si hay mate y bombilla
                if (item.tipos.includes('mate')) hayMate = true;
                if (item.tipos.includes('bombilla')) hayBombilla = true;
                
                total += item.precio;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'carrito-panel-item';
                itemElement.innerHTML = `
                    <img src="${item.imagen}" alt="${item.nombre}" loading="lazy">
                    <div class="carrito-panel-item-info">
                        <h3>${item.nombre}</h3>
                        <p>$${item.precio}</p>
                    </div>
                    <button class="btn-eliminar" onclick="eliminarDelCarrito(${index})">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                `;
                panelItems.appendChild(itemElement);
            });

            // Aplicar descuento si hay mate y bombilla
            let descuento = 0;
            if (hayMate && hayBombilla) {
                descuento = total * 0.1;
                const descuentoElement = document.createElement('div');
                descuentoElement.className = 'carrito-panel-item descuento-item';
                descuentoElement.innerHTML = `
                    <div class="carrito-panel-item-info">
                        <h3>Descuento mate + bombilla (10% OFF)</h3>
                    </div>
                    <div class="descuento-valor">-$${descuento}</div>
                `;
                panelItems.appendChild(descuentoElement);
            }
            
            totalElement.textContent = total - descuento;
        }

        function eliminarDelCarrito(index) {
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            carrito.splice(index, 1);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            actualizarContadorCarrito();
            actualizarPanelCarrito();
            
            // Si el carrito está vacío, mostrar el total en 0 antes de cerrar el panel
            if (carrito.length === 0) {
                document.getElementById('carrito-panel-total').textContent = '0';
                cerrarCarrito();
            }
        }

        let modalTimeout;
        let modalTimerInterval;
        const MODAL_TIMER_DURATION = 5000; // 5 segundos
        const MODAL_CIRCLE_LENGTH = 87.96; // Circunferencia del círculo SVG

        function iniciarAnimacionCirculoModal() {
            const progress = document.getElementById('modal-timer-progress');
            if (!progress) return;
            progress.style.strokeDashoffset = MODAL_CIRCLE_LENGTH;
            let start = Date.now();
            if (modalTimerInterval) clearInterval(modalTimerInterval);
            modalTimerInterval = setInterval(() => {
                let elapsed = Date.now() - start;
                let percent = Math.min(elapsed / MODAL_TIMER_DURATION, 1);
                progress.style.strokeDashoffset = MODAL_CIRCLE_LENGTH * (1 - percent);
                if (percent >= 1) {
                    clearInterval(modalTimerInterval);
                }
            }, 50);
        }

        function reiniciarModalTimer() {
            if (modalTimeout) clearTimeout(modalTimeout);
            if (modalTimerInterval) clearInterval(modalTimerInterval);
            iniciarAnimacionCirculoModal();
            modalTimeout = setTimeout(() => {
                cerrarModal();
            }, MODAL_TIMER_DURATION);
        }

        function mostrarModalCarrito(producto) {
            const modal = document.getElementById('carrito-modal');
            const modalContent = document.getElementById('carrito-modal-content');
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            let total = 0;
            let hayMate = false;
            let hayBombilla = false;

            // Mostrar todos los productos del carrito en el modal
            modalContent.innerHTML = carrito.map((item, index) => {
                if (item.tipos.includes('mate')) hayMate = true;
                if (item.tipos.includes('bombilla')) hayBombilla = true;
                total += item.precio;
                return `
                    <div class="carrito-modal-item modal-item-unificado" style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                        <img src="${item.imagen}" alt="${item.nombre}" style="width: 60px; height: 60px; object-fit: cover; margin-right: 10px;" loading="lazy">
                        <div style="flex: 1; text-align: left;">
                            <h3 style="margin: 0 0 5px 0; font-size: 16px;">${item.nombre}</h3>
                            <p style="margin: 0; font-size: 15px;">$${item.precio}</p>
                        </div>
                        <button class="btn-eliminar-modal" onclick="eliminarDelCarritoModal(${index})" style="background-color: #ff4444; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 8px;">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="white" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                `;
            }).join('');

            // Aplicar descuento si hay mate y bombilla
            let descuento = 0;
            if (hayMate && hayBombilla) {
                descuento = Math.round(total * 0.1);
                modalContent.innerHTML += `
                    <div class="carrito-modal-item descuento-item modal-item-unificado" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <div style="flex: 1; text-align: left;">
                            <h3 style="margin: 0; font-size: 16px; color: #2d5d52;">Descuento mate + bombilla (10% OFF)</h3>
                        </div>
                        <div style="font-weight: bold; color: #2d5d52;">-$${descuento}</div>
                    </div>
                `;
            }
            // Mostrar el total final
            modalContent.innerHTML += `
                <div class=\"carrito-modal-item modal-item-unificado total-modal-item\">
                    <span class=\"total-modal-label\">Total:</span>
                    <span class=\"total-modal-value\">$${total - descuento}</span>
                </div>
            `;

            modal.classList.add('active');
            document.getElementById('carrito-overlay').classList.add('active');

            reiniciarModalTimer();
        }

        function eliminarDelCarritoModal(index) {
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            carrito.splice(index, 1);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            actualizarContadorCarrito();
            // Si el carrito queda vacío, cerrar el modal
            if (carrito.length === 0) {
                cerrarModal();
            } else {
                // Volver a mostrar el modal actualizado y reiniciar el timeout
                mostrarModalCarrito({});
            }
        }

        function cerrarModal() {
            const modal = document.getElementById('carrito-modal');
            const overlay = document.getElementById('carrito-overlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
            if (modalTimeout) clearTimeout(modalTimeout);
            if (modalTimerInterval) clearInterval(modalTimerInterval);
            // Resetear círculo
            const progress = document.getElementById('modal-timer-progress');
            if (progress) progress.style.strokeDashoffset = MODAL_CIRCLE_LENGTH;
        }

        function mostrarPanelCarrito() {
            const panel = document.getElementById('carrito-panel');
            const overlay = document.getElementById('carrito-overlay');
            panel.classList.add('active');
            overlay.classList.add('active');
            actualizarPanelCarrito();
        }

        function cerrarCarrito() {
            const panel = document.getElementById('carrito-panel');
            const overlay = document.getElementById('carrito-overlay');
            panel.classList.remove('active');
            overlay.classList.remove('active');
            
            // Limpiar el contenido del panel
            document.getElementById('carrito-panel-items').innerHTML = '';
            document.getElementById('carrito-panel-total').textContent = '0';
        }

        function agregarAlCarrito(id) {
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const producto = productos.find(p => p.id === id);
            
            if (producto) {
                carrito.push(producto);
                localStorage.setItem('carrito', JSON.stringify(carrito));
                actualizarContadorCarrito();
                mostrarCarritoFlotante();
                
                // Mostrar panel o modal según el tamaño de la pantalla
                if (window.innerWidth > 768) {
                    mostrarPanelCarrito();
                } else {
                    mostrarModalCarrito(producto);
                }
            }
        }

        function mostrarCarritoFlotante() {
            const carritoFlotante = document.getElementById('carrito-flotante');
            carritoFlotante.classList.add('visible');
        }

        // Agregar event listeners para cerrar el panel
        document.addEventListener('DOMContentLoaded', () => {
            cargarProductos(); // Cargar productos al iniciar
            document.getElementById('carrito-panel-close').addEventListener('click', cerrarCarrito);
            document.getElementById('carrito-modal-close').addEventListener('click', cerrarModal);
            document.getElementById('carrito-overlay').addEventListener('click', () => {
                if (window.innerWidth > 768) {
                    cerrarCarrito();
                } else {
                    cerrarModal();
                }
            });

            // Event listeners para el panel de producto
            document.getElementById('producto-panel-close').addEventListener('click', cerrarPanelProducto);
            document.getElementById('producto-panel-overlay').addEventListener('click', cerrarPanelProducto);

            // Interacción dentro del modal reinicia el temporizador
            document.getElementById('carrito-modal').addEventListener('mousedown', (e) => {
                // Solo reiniciar si el modal está activo y el click no es en el overlay
                if (window.innerWidth <= 768 && document.getElementById('carrito-modal').classList.contains('active')) {
                    reiniciarModalTimer();
                }
            });

            // Resto del código existente
            activarFiltroPorHash();
            filtrarProductos();
            
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            if (carrito.length > 0) {
                mostrarCarritoFlotante();
            }
            actualizarContadorCarrito();
        });

        // Escuchar cambios en el hash de la URL
        window.addEventListener('hashchange', () => {
            activarFiltroPorHash();
            filtrarProductos();
        });

        // Control del menú móvil
        const burgerButton = document.querySelector('.main-header-burguer');
        const mobileMenu = document.querySelector('.mobile-menu');

        burgerButton.addEventListener('click', () => {
            burgerButton.classList.toggle('active');
            mobileMenu.classList.toggle('active');
        });

        // Cerrar menú al hacer clic en un enlace
        const mobileLinks = document.querySelectorAll('.mobile-menu a');
        mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
                burgerButton.classList.remove('active');
                mobileMenu.classList.remove('active');
            });
        });

        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!burgerButton.contains(e.target) && !mobileMenu.contains(e.target)) {
                burgerButton.classList.remove('active');
                mobileMenu.classList.remove('active');
            }
        });

        // Panel de producto
        function mostrarPanelProducto(id) {
            const producto = productos.find(p => p.id === id);
            if (!producto) return;

            const panel = document.getElementById('producto-panel');
            const overlay = document.getElementById('producto-panel-overlay');
            const mainImage = document.getElementById('producto-panel-main-image');
            const thumbnails = document.getElementById('producto-panel-thumbnails');
            const nombre = document.getElementById('producto-panel-nombre');
            const descripcion = document.getElementById('producto-panel-descripcion');
            const precio = document.getElementById('producto-panel-precio');
            const btnComprar = document.getElementById('btn-comprar-ahora');
            const btnAgregar = document.getElementById('btn-agregar-panel');

            // Actualizar contenido
            nombre.textContent = producto.nombre;
            descripcion.textContent = producto.descripcion;
            precio.textContent = `$${producto.precio}`;

            // Configurar imágenes
            const todasLasFotos = [producto.imagen, ...producto.fotosExtras].filter(Boolean);
            mainImage.src = todasLasFotos[0];
            mainImage.alt = producto.nombre;

            // Limpiar y agregar miniaturas
            thumbnails.innerHTML = '';
            todasLasFotos.forEach((foto, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = foto;
                thumbnail.alt = `${producto.nombre} - Vista ${index + 1}`;
                thumbnail.className = 'producto-panel-thumbnail' + (index === 0 ? ' active' : '');
                thumbnail.onclick = () => {
                    mainImage.src = foto;
                    document.querySelectorAll('.producto-panel-thumbnail').forEach(thumb => {
                        thumb.classList.remove('active');
                    });
                    thumbnail.classList.add('active');
                };
                thumbnails.appendChild(thumbnail);
            });

            // Configurar botones
            btnComprar.onclick = () => {
                const mensaje = `Hola, me gustaría comprar el siguiente producto:\n\n${producto.nombre}\nPrecio: $${producto.precio}`;
                window.open(`https://wa.me/5491125129852?text=${encodeURIComponent(mensaje)}`, '_blank');
            };

            btnAgregar.onclick = () => {
                agregarAlCarrito(producto.id);
                cerrarPanelProducto();
            };

            // Deshabilitar botones si no hay stock
            if (!producto.stock) {
                btnComprar.disabled = true;
                btnComprar.style.backgroundColor = '#ccc';
                btnComprar.style.cursor = 'not-allowed';
                btnComprar.textContent = 'No disponible';
                
                btnAgregar.disabled = true;
                btnAgregar.style.backgroundColor = '#ccc';
                btnAgregar.style.cursor = 'not-allowed';
                btnAgregar.textContent = 'No disponible';
            } else {
                btnComprar.disabled = false;
                btnComprar.style.backgroundColor = '';
                btnComprar.style.cursor = '';
                btnComprar.textContent = 'Comprar Ahora';
                
                btnAgregar.disabled = false;
                btnAgregar.style.backgroundColor = '';
                btnAgregar.style.cursor = '';
                btnAgregar.textContent = 'Agregar al Carrito';
            }

            // Mostrar panel
            panel.classList.add('active');
            overlay.classList.add('active');
        }

        function cerrarPanelProducto() {
            const panel = document.getElementById('producto-panel');
            const overlay = document.getElementById('producto-panel-overlay');
            panel.classList.remove('active');
            overlay.classList.remove('active');
        }

        function abrirEncargueWhatsapp(id) {
            const producto = productos.find(p => p.id === id);
            if (!producto) return;
            
            const mensaje = `Hola, no tenés el producto *${producto.nombre}* en stock, pero quisiera encargártelo.`;
            window.open(`https://wa.me/5491125129852?text=${encodeURIComponent(mensaje)}`, '_blank');
        }
    </script>

    <!-- Panel lateral del carrito -->
    <div class="carrito-overlay" id="carrito-overlay"></div>
    <div class="carrito-panel" id="carrito-panel">
        <div class="carrito-panel-header">
            <h2>Carrito de Compras</h2>
            <button class="carrito-panel-close" id="carrito-panel-close">&times;</button>
        </div>
        <div id="carrito-panel-items">
            <!-- Los items se agregarán dinámicamente -->
        </div>
        <div class="carrito-panel-total">
            Total: $<span id="carrito-panel-total">0</span>
        </div>
        <div class="carrito-panel-buttons">
            <button class="btn-ir-carrito" onclick="window.location.href='./carrito.html'">Ir al Carrito</button>
            <button class="btn-seguir-comprando" onclick="cerrarCarrito()">Seguir Comprando</button>
        </div>
    </div>

    <!-- Modal móvil del carrito -->
    <div class="carrito-modal" id="carrito-modal">
        <div class="carrito-modal-header">
            <h2>Producto Agregado</h2>
            <button class="carrito-modal-close" id="carrito-modal-close" style="position: relative;">
                <svg id="modal-timer-circle" width="32" height="32" style="position: absolute; top: 0; left: 0; pointer-events: none;" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" stroke="#38675a" stroke-width="3" fill="none" opacity="0.2"/>
                    <circle id="modal-timer-progress" cx="16" cy="16" r="14" stroke="#38675a" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="87.96" stroke-dashoffset="87.96"/>
                </svg>
                <span style="position: relative; z-index: 2; color: #38675a;">&times;</span>
            </button>
        </div>
        <div class="carrito-modal-content" id="carrito-modal-content">
            <!-- El contenido se agregará dinámicamente -->
        </div>
        <div class="carrito-modal-buttons">
            <button class="btn-ir-carrito" onclick="window.location.href='./carrito.html'">Ir al Carrito</button>
            <button class="btn-seguir-comprando" onclick="cerrarModal()">Seguir Comprando</button>
        </div>
    </div>

    <!-- Panel de producto -->
    <div class="producto-panel-overlay" id="producto-panel-overlay"></div>
    <div class="producto-panel" id="producto-panel">
        <div class="producto-panel-header">
            <h2>Detalles del Producto</h2>
            <button class="producto-panel-close" id="producto-panel-close">&times;</button>
        </div>
        <div class="producto-panel-content">
            <div class="producto-panel-images">
                <img src="" alt="" class="producto-panel-main-image" id="producto-panel-main-image">
                <div class="producto-panel-thumbnails" id="producto-panel-thumbnails">
                    <!-- Las miniaturas se agregarán dinámicamente -->
                </div>
            </div>
            <div class="producto-panel-info">
                <h2 id="producto-panel-nombre"></h2>
                <p id="producto-panel-descripcion"></p>
                <p class="producto-panel-precio" id="producto-panel-precio"></p>
                <div class="producto-panel-buttons">
                    <button class="btn-comprar-ahora" id="btn-comprar-ahora">Comprar Ahora</button>
                    <button class="btn-agregar-panel" id="btn-agregar-panel">Agregar al Carrito</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>